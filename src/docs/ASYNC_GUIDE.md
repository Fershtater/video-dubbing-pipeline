# Руководство по асинхронной обработке

Асинхронная обработка в конвейере дублирования даёт ускорение синтеза TTS в 3–5 раз.

## Обзор

Несколько TTS-запросов выполняются параллельно, что заметно сокращает время для видео с большим числом сегментов.

## Быстрый старт

```bash
# Асинхронный режим
make full-async VIDEO=media/ваше_видео.mp4

# Только этап синтеза
make synth-async VIDEO=media/ваше_видео.mp4
```

## Сравнение производительности

| Видео | Сегментов | Sync | Async (5 потоков) | Ускорение |
| ----- | --------- | ---- | ----------------- | --------- |
| 3.mp4 | 37        | 73 с | 15 с              | 4.9×      |
| 2.mp4 | 25        | 45 с | 12 с              | 3.8×      |
| 1.mp4 | 15        | 28 с | 8 с               | 3.5×      |

### Влияние конкурентности

| Параллельных запросов | Время | Ускорение | Нагрузка на API   |
| --------------------- | ----- | --------- | ----------------- |
| 1 (sync)              | 73 с  | 1×        | Низкая            |
| 3                     | 20 с  | 3.6×      | Средняя           |
| 5 (по умолчанию)      | 15 с  | 4.9×      | **Рекомендуется** |
| 10                    | 12 с  | 6.1×      | Высокая           |

## Конфигурация

```bash
make synth-async VIDEO=media/video.mp4
make synth-async VIDEO=media/video.mp4 MAX_CONCURRENT=8
make full-async VIDEO=media/video.mp4 MAX_CONCURRENT=5
```

В `.env`:

```bash
MAX_CONCURRENT=5
```

## Команды

| Команда                  | Описание               | Когда использовать         |
| ------------------------ | ---------------------- | -------------------------- |
| `make synth-async`       | Только асинхронный TTS | Когда уже есть prep-данные |
| `make full-async`        | Полный async-конвейер  | Новое видео                |
| `make debug-synth-async` | Режим отладки          | Устранение неполадок       |

```bash
make debug-synth-async VIDEO=media/video.mp4 MAX_CONCURRENT=3
make show-logs WORKDIR=.work/lesson
```

## Технические детали

### Компоненты

- **tts_async.py** — асинхронные функции TTS
- **timeline_async.py** — построение таймлайна
- **cli_async.py** — async CLI
- **tqdm[asyncio]** — прогресс-бары

### Как это работает

1. Сегменты обрабатываются батчами
2. Несколько TTS-запросов отправляются параллельно
3. Семафор ограничивает число одновременных запросов
4. Прогресс отображается в реальном времени
5. Ошибки обрабатываются с повторными попытками

### Память

- Обработка батчами, кэширование сгенерированного аудио, очистка временных файлов

## Рекомендации

**Начните с `MAX_CONCURRENT=5`** и подстройте под:

- скорость интернета
- лимиты API (OpenAI)
- объём оперативной памяти

**Когда использовать async:**

- больше ~20 сегментов
- OpenAI TTS
- важна скорость
- стабильный интернет

**Когда использовать sync:**

- отладка TTS
- короткие видео (<10 сегментов)
- ElevenLabs TTS
- нестабильный интернет

## Устранение неполадок

**«Rate limit exceeded»** — уменьшите `MAX_CONCURRENT` (например, до 3).

**«Memory error»** — уменьшите конкурентность, проверьте память.

**«Connection timeout»** — проверьте сеть, уменьшите `MAX_CONCURRENT` (например, до 2).

**Прогресс не отображается** — в Makefile используется `PYTHONUNBUFFERED=1`; проверьте поддержку прогресс-баров в терминале.

**Режим отладки:**

```bash
make debug-synth-async VIDEO=media/video.mp4
cat .work/lesson/synth_async.log
```

## Ограничения

- **ElevenLabs** — пока только синхронный режим
- **Очень длинные видео** — может понадобиться меньшая конкурентность
- **Лимиты API** — при высокой конкурентности лимиты достигаются быстрее

## Примеры

```bash
make full-async VIDEO=media/tutorial.mp4
make synth-async VIDEO=media/long_video.mp4 MAX_CONCURRENT=10
make synth-async VIDEO=media/short_video.mp4 MAX_CONCURRENT=2
make debug-synth-async VIDEO=media/video.mp4 MAX_CONCURRENT=3
```

При проблемах: раздел выше, логи в `.work/lesson/synth_async.log`, уменьшение `MAX_CONCURRENT` до 3 или 2, проверка квот API.
